#!/usr/bin/env bash

set -euo pipefail

REPO_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
DMG_PATH="${REPO_ROOT}/dist/HushDesk.dmg"

PASSWORD_SOURCE="${APPLE_SPECIFIC_PASSWORD:-${APP_SPECIFIC_PASSWORD:-}}"

if [ -z "${APPLE_ID:-}" ]; then
  echo "error: APPLE_ID environment variable is required" >&2
  exit 1
fi

if [ -z "${TEAM_ID:-}" ]; then
  echo "error: TEAM_ID environment variable is required" >&2
  exit 1
fi

if [ -z "${PASSWORD_SOURCE}" ]; then
  echo "error: set APP_SPECIFIC_PASSWORD (or APPLE_SPECIFIC_PASSWORD) environment variable" >&2
  exit 1
fi

if [ ! -f "${DMG_PATH}" ]; then
  echo "error: ${DMG_PATH} not found. Run ./scripts/build before notarizing." >&2
  exit 1
fi

cd "${REPO_ROOT}"

xcrun notarytool submit "${DMG_PATH}" \
  --apple-id "${APPLE_ID}" \
  --team-id "${TEAM_ID}" \
  --password "${PASSWORD_SOURCE}" \
  --wait

xcrun stapler staple "${DMG_PATH}"

spctl -a -t open --context context:primary-signature -v "${DMG_PATH}"

echo "Notarization and verification completed for ${DMG_PATH}"
