#!/usr/bin/env bash

set -euo pipefail

REPO_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
APP_PATH="${REPO_ROOT}/dist/HushDesk.app"
ENTITLEMENTS_PATH="${ENTITLEMENTS_PATH:-}"

if [ -z "${CODESIGN_ID:-}" ]; then
  echo "error: CODESIGN_ID environment variable is required" >&2
  exit 1
fi

if [ -z "${TEAM_ID:-}" ]; then
  echo "error: TEAM_ID environment variable is required" >&2
  exit 1
fi

if [ ! -d "${APP_PATH}" ]; then
  echo "error: ${APP_PATH} not found. Run ./scripts/build first." >&2
  exit 1
fi

cd "${REPO_ROOT}"

SIGN_ARGS=(--deep --force --options runtime --timestamp)
if [ -n "${ENTITLEMENTS_PATH}" ]; then
  if [ ! -f "${ENTITLEMENTS_PATH}" ]; then
    echo "error: entitlements file ${ENTITLEMENTS_PATH} not found" >&2
    exit 1
  fi
  SIGN_ARGS+=(--entitlements "${ENTITLEMENTS_PATH}")
fi
SIGN_ARGS+=(--sign "${CODESIGN_ID}" "${APP_PATH}")

codesign "${SIGN_ARGS[@]}"

codesign --verify --deep --strict --verbose=2 "${APP_PATH}"

echo "Codesign verification passed for ${APP_PATH}"
