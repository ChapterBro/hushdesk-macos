#!/usr/bin/env bash
set -Eeuo pipefail
ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
APP="$ROOT/dist/HushDesk.app"
PYINSTALLER="${PYINSTALLER_BIN:-$(command -v pyinstaller || true)}"
[[ -x "$PYINSTALLER" ]] || { echo "PyInstaller not found. Set PYINSTALLER_BIN or install it."; exit 1; }
echo "==> Building with: $PYINSTALLER"
rm -rf "$ROOT/dist"
mkdir -p "$ROOT/dist"
"$PYINSTALLER" --noconfirm "$ROOT/HushDesk.spec"
echo "==> Stamping Info.plist"
"$ROOT/scripts/stamp_version" "$APP"
echo "==> Clearing quarantine (local-only)"
xattr -dr com.apple.quarantine "$APP" || true
[[ "${DESKTOP_ALIAS:-0}" == "1" ]] && osascript -e 'tell application "Finder" to make new alias file at (path to desktop) to POSIX file "'"$APP"'"' && echo "Desktop alias â†’ $APP" || true
echo "Build: PASS"
