#!/usr/bin/env bash

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
PLIST="${REPO_ROOT}/dist/HushDesk.app/Contents/Info.plist"
INIT_FILE="${REPO_ROOT}/src/hushdesk/__init__.py"

if [ ! -f "${PLIST}" ]; then
  echo "error: Info.plist not found at ${PLIST}" >&2
  exit 1
fi

VERSION_VALUE="${VERSION:-}"
if [ -z "${VERSION_VALUE}" ]; then
  VERSION_VALUE="$(
    python3 - "${INIT_FILE}" <<'PY'
import re
import sys
from pathlib import Path

try:
    text = Path(sys.argv[1]).read_text(encoding="utf-8")
except FileNotFoundError:
    pass
else:
    match = re.search(r"__version__\s*=\s*['\"]([^'\"]+)['\"]", text)
    if match:
        print(match.group(1), end="")
PY
  )"
fi

if [ -z "${VERSION_VALUE}" ]; then
  VERSION_VALUE="0.1.0"
fi

BUILD_VALUE="${BUILD:-}"
if [ -z "${BUILD_VALUE}" ]; then
  BUILD_VALUE="$(date -u +%Y%m%d%H%M%S)"
fi

VERSION="${VERSION_VALUE}"
BUILD="${BUILD_VALUE}"

/usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString ${VERSION}" "${PLIST}" 2>/dev/null \
  || /usr/libexec/PlistBuddy -c "Add :CFBundleShortVersionString string ${VERSION}" "${PLIST}"
/usr/libexec/PlistBuddy -c "Set :CFBundleVersion ${BUILD}" "${PLIST}" 2>/dev/null \
  || /usr/libexec/PlistBuddy -c "Add :CFBundleVersion string ${BUILD}" "${PLIST}"
/usr/libexec/PlistBuddy -c "Set :CFBundleName HushDesk" "${PLIST}" 2>/dev/null \
  || /usr/libexec/PlistBuddy -c "Add :CFBundleName string HushDesk" "${PLIST}"
/usr/libexec/PlistBuddy -c "Set :CFBundleDisplayName HushDesk" "${PLIST}" 2>/dev/null \
  || /usr/libexec/PlistBuddy -c "Add :CFBundleDisplayName string HushDesk" "${PLIST}"

echo "Stamped VERSION: ${VERSION}"
echo "Stamped BUILD:   ${BUILD}"
