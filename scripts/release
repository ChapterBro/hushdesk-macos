#!/usr/bin/env bash

set -euo pipefail

REPO_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
VERSION="${VERSION:-}"
DMG_SOURCE="${REPO_ROOT}/dist/HushDesk.dmg"
CHANGELOG_PATH="${REPO_ROOT}/CHANGELOG.md"

if [ -z "${VERSION}" ]; then
  echo "error: set VERSION environment variable (e.g., VERSION=1.0.0)" >&2
  exit 1
fi

if [ ! -f "${DMG_SOURCE}" ]; then
  echo "error: ${DMG_SOURCE} not found. Run ./scripts/build before releasing." >&2
  exit 1
fi

if ! command -v gh >/dev/null 2>&1; then
  echo "error: GitHub CLI (gh) is required for release automation" >&2
  exit 1
fi

DMG_VERSIONED="${REPO_ROOT}/dist/HushDesk-${VERSION}.dmg"
cp "${DMG_SOURCE}" "${DMG_VERSIONED}"

gh release create "v${VERSION}" "${DMG_VERSIONED}" \
  --title "HushDesk ${VERSION}" \
  --notes-file "${CHANGELOG_PATH}"

echo "Release v${VERSION} published with artifact ${DMG_VERSIONED}"
