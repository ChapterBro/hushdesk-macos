name: hushdesk-ci
on: [push, pull_request]
jobs:
  macos-py311:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          ( [ -f requirements-dev.txt ] && pip install -r requirements-dev.txt ) || pip install pymupdf==1.24.10 Pillow==10.4.0 pytest==8.3.4
      - name: Compile
        run: |
          python -m compileall -q src
          python -m compileall -q tools || true
      - name: Import smoke
        run: PYTHONNOUSERSITE=1 PYTHONPATH=src python tools/import_smoke.py
      - name: Strict-only tests (if present)
        run: |
          set -euo pipefail

          strict_tests=(
            "tests/test_rules_master_strict_only.py"
            "tests/test_hr_false_positive.py"
          )

          existing_tests=()
          for test_path in "${strict_tests[@]}"; do
            if [ -f "$test_path" ]; then
              existing_tests+=("$test_path")
            fi
          done

          if [ "${#existing_tests[@]}" -eq 0 ]; then
            echo "No strict-only tests present; skipping."
            exit 0
          fi

          PYTHONNOUSERSITE=1 PYTHONPATH=src pytest -q "${existing_tests[@]}"
